# 1️⃣ Imagen de Python 3.12
FROM python:3.9

# 2️⃣ Variables de entorno para Python
# Evitan archivos .pyc innecesarios y aseguran que la salida de logs no se bufferice
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# 3️⃣ Crear un usuario no-root seguro
# ARG permite pasar UID y GID dinámicamente si lo necesitas
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN groupadd -g ${GROUP_ID} appuser && \
    useradd -u ${USER_ID} -g appuser -m -s /bin/sh appuser

# 4️⃣ Establecer el directorio de trabajo dentro del contenedor
WORKDIR /usr/src/app

# 5️⃣ Copiar solo requirements.txt primero
# Esto permite aprovechar la cache de Docker y no reinstalar dependencias cada vez
COPY --chown=appuser:appuser requirements.txt .

# 6️⃣ Instalar dependencias como root
# Necesario porque pip necesita permisos de escritura en site-packages
RUN pip install --upgrade pip && \
    pip install -r requirements.txt

# 7️⃣ Copiar el resto del código como usuario no-root
# Esto asegura que appuser pueda escribir archivos de migraciones, logs, etc.
COPY --chown=appuser:appuser . .

# 8️⃣ Cambiar a usuario no-root para todo lo que ejecute el contenedor
# Evita el uso de sudo y mejora la seguridad
USER appuser
